<fieldset>
  <div class="form-card">

    <div class="secondary-container title-bar">
      <div class="row">
        <div class="col-7">
          <h2 class="fs-title">Lifestyle</h2>
        </div>
        <div class="col-5">
          <h2 class="steps">Step 3 - 6</h2>
        </div>
      </div>
    </div>

    <div id="addPlace3"></div>

  </div> 

  <input type="button" name="next" class="next action-button" value="Next" />
  <input type="button" name="previous" class="previous action-button-previous" value="Previous" />

  <script>
    let substanceNames = <%- JSON.stringify(substanceNamesJson)%>
    $.get("/profile/getSectionData/Lifestyle", (data) => {
      let elmStr = "";
      for (let i = 0; i < data.subSections.length; i++) {
        if(data.subSections[i].name == "Substance Use History")elmStr += getSubSectionStr3(data.subSections[i]);
        else elmStr += getSubSectionStr(data.subSections[i]);
      }
      $("#addPlace3").replaceWith(elmStr);
    });

    function getSubSectionStr3(subSection) {
      let  elmStr1= "", elmStr2=""
      
      for(let i = 0 ; i < Math.ceil(substanceNames.length/2); i++) {
        let qStr = ''
        for (let j = 0; j < subSection.questions.length; j++) {
          qStr += getQuestionStr3(substanceNames[i], subSection.questions[j]);
        }

        elmStr1+= '<div class="card collapse-item">'+
                    '<div class="card-header collapse-item-header" id="heading-'+i+'" data-toggle="collapse"'+
                      'data-target="#collapse-'+i+'">'+
                      ((i == 0)?

                      ('<a class="btn text-left" role="button" aria-expanded="true" aria-controls="collapse-'+i+'">'+
                        '<h6> '+substanceNames[i].name+'</h6>'+
                      '</a>')
                      :
                      ('<a class="btn collapsed text-left" role="button" aria-expanded="false" aria-controls="collapse-'+i+'">'+
                        '<h6> '+substanceNames[i].name+'</h6>'+
                      '</a>'))+

                    '</div>'+

                    ((i == 0)?
                    ('<div id="collapse-'+i+'" class="collapse show" aria-labelledby="heading-'+i+'"'+
                      'data-parent="#substanceAccordion-1">')
                    :
                    ('<div id="collapse-'+i+'" class="collapse" aria-labelledby="heading-'+i+'"'+
                      'data-parent="#substanceAccordion-1">')) +        
                      '<div class="card-body">'+
                        qStr+
                      '</div>'+
                    '</div>'+
                  '</div>'
      
      }

      for(let i = Math.ceil(substanceNames.length/2) ; i < substanceNames.length; i++) {
        let qStr = ''
        for (let j = 0; j < subSection.questions.length; j++) {
          qStr += getQuestionStr3(substanceNames[i], subSection.questions[j]);
        }

        elmStr2+= '<div class="card collapse-item">'+
                    '<div class="card-header collapse-item-header" id="heading-'+i+'" data-toggle="collapse"'+
                      'data-target="#collapse-'+i+'">'+
                      ((i == Math.ceil(substanceNames.length/2))?

                      ('<a class="btn text-left" role="button" aria-expanded="true" aria-controls="collapse-'+i+'">'+
                        '<h6> '+substanceNames[i].name+'</h6>'+
                      '</a>')
                      :
                      ('<a class="btn collapsed text-left" role="button" aria-expanded="false" aria-controls="collapse-'+i+'">'+
                        '<h6> '+substanceNames[i].name+'</h6>'+
                      '</a>'))+

                    '</div>'+

                    ((i == Math.ceil(substanceNames.length/2))?
                    ('<div id="collapse-'+i+'" class="collapse show" aria-labelledby="heading-'+i+'"'+
                      'data-parent="#substanceAccordion-2">')
                    :
                    ('<div id="collapse-'+i+'" class="collapse" aria-labelledby="heading-'+i+'"'+
                      'data-parent="#substanceAccordion-2">')) +        
                      '<div class="card-body">'+                        
                        qStr+
                      '</div>'+
                    '</div>'+
                  '</div>'
      
      } 

      return  '<div>'+
                '<div class="secondary-container">'+
                  '<h4 class="subsection-title">' + subSection.name + '</h4>'+
                '</div>'+
                '<div class="subtance-history-container">'+
                  '<div class="accordion secondary-container" id="substanceAccordion-1">'+
                    elmStr1+
                  '</div>'+
                  '<div class="accordion secondary-container" id="substanceAccordion-2">'+
                    elmStr2+
                  '</div>'+
                '</div>'+
              '</div>'
              
              

    }

  function getQuestionStr3(substanceName, question) {
    console.log('came in 3')
    let elmStr = "";
    elmStr += '<label class="fieldlabels">' + question.name + "</label>";
    if (question.inputType == "numerical")
      elmStr +=' <input type="number" name="' + question._id + '" placeholder="" />';
    else if (question.inputType == "date")
      elmStr +=' <input type="date" name="' + question._id + '" placeholder="" />';
    else if (question.inputType == "singleLine")
      elmStr +=' <input type="text" name="' + question._id + '" placeholder="" />';
    else if (question.inputType == "multiLine")
      elmStr +='<textarea class="form-control" name="' + question._id + '"  rows="3"></textarea>'
    else if (question.inputType == "multiChoiceSingleAns")
      elmStr += getMultiChoiceSingleOp3(substanceName, question._id, question.options)
    else if (question.inputType == "multiChoiceMultiAns")
      elmStr += getMultiChoiceMultiOp3(substanceName, question._id, question.options)

    return elmStr+ '<br>';
  }

  function getMultiChoiceSingleOp3(substanceName, qId, options){
      let elmStr = ''
      let conditionalPart='', condArrayStr = '['

      for(let i=0; i<options.length; i++){
        if(options[i].questions.length>0)
          condArrayStr += '\'conditional'+substanceName+options[i]._id+'\', '
      }
      condArrayStr+=']'

      for(let i=0; i<options.length; i++){
        if(options[i].questions.length>0){
          let str = "\'conditional"+substanceName+options[i]._id+"\'," 
          let newCondArray = condArrayStr.replace(str, '')
          elmStr += '<div class="custom-control custom-radio">'+
          '<input type="radio" id="'+options[i]._id+'" name="'+substanceName + qId +'" class="custom-control-input" value="'+options[i].name+'" onclick="hideConditionalSection('+newCondArray+'); displayConditionalSection([\'conditional'+substanceName+options[i]._id+'\']); ">'+
          '<label class="custom-control-label" for="'+options[i]._id+'">'+options[i].name+'</label>'+
          '</div>'
          let qStr = ''
          for(let j=0; j<options[i].questions.length; j++){
            qStr+= getQuestionStr3(substanceName, options[i].questions[j])
          }
          conditionalPart += '<div id= "conditional'+substanceName+options[i]._id+'" style="display: none;">'+ qStr +'</div>'
        }
        else{
          elmStr += '<div class="custom-control custom-radio">'+
          '<input type="radio" id="'+options[i]._id+'" name="'+substanceName + qId +'" class="custom-control-input" value="'+options[i].name+'" onclick="hideConditionalSection('+condArrayStr+');">'+
          '<label class="custom-control-label" for="'+options[i]._id+'">'+options[i].name+'</label>'+
          '</div>'
        }
      }
      return elmStr+conditionalPart
  }

  function getMultiChoiceMultiOp3(substanceName, qId, options){
    let elmStr = ''

    for(let i=0; i<options.length; i++){
      elmStr += '<div class="custom-control custom-checkbox">'+
        '<input type="checkbox" id="'+options[i]._id+'" name="'+ qId +'" class="custom-control-input" value="'+options[i].name+'" onclick="displayConditionalSectionCheckbox(\''+options[i]._id+'\' , \'conditional'+substanceName+options[i]._id+'\'); ">'+
        '<label class="custom-control-label" for="'+options[i]._id+'">'+options[i].name+'</label>'+
        '</div>'
      
      if(options[i].questions.length>0){  
        let qStr = ''
        for(let j=0; j<options[i].questions.length; j++){
          qStr+= getQuestionStr3(substanceName, options[i].questions[j])
        }
        elmStr += '<div id= "conditional'+substanceName+options[i]._id+'" style="display: none;">'+ qStr +'</div>'
      }
    }
    return elmStr
  }
</script>

</fieldset>